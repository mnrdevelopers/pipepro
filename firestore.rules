rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper: Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper: Check if user is accessing their own data
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // Helper: Check if user is a team member of the business owner
    // This reads the requesting user's profile to check their 'businessId'
    function isTeamMember(businessOwnerId) {
      return isSignedIn() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.businessId == businessOwnerId;
    }

    function isBusinessOwner(businessOwnerId) {
      return isSignedIn() && request.auth.uid == businessOwnerId;
    }

    // Public landing page data (read-only for visitors)
    match /public/{businessOwnerId} {
      allow read: if true;
      allow write: if isBusinessOwner(businessOwnerId);
      match /featured_stock/{doc=**} {
        allow read: if true;
        allow write: if isBusinessOwner(businessOwnerId);
      }
    }

    match /users/{userId} {
      // 1. User Profile: Allow users to read/write their own profile
      // This is essential for login to fetch role and businessId
      // Also allow the Business Owner (employer) to update the profile (e.g. role change)
      allow read, write: if isOwner(userId) || (isSignedIn() && resource != null && resource.data.businessId == request.auth.uid);

      // 2. Team Management: Only the Owner can access the 'team' subcollection
      // This prevents staff from adding/removing other staff
      match /team/{memberId} {
        allow read, write: if isOwner(userId);
      }

      // 3. Business Data Collections
      // Allow access if user is the Owner OR a Team Member linked to this Owner.
      // We list collections explicitly to avoid accidentally exposing the 'team' collection via a wildcard.
      
      match /inventory/{doc=**} { allow read, write: if isOwner(userId) || isTeamMember(userId); }
      match /customers/{doc=**} { allow read, write: if isOwner(userId) || isTeamMember(userId); }
      match /projects/{doc=**} { allow read, write: if isOwner(userId) || isTeamMember(userId); }
      match /orders/{doc=**} { allow read, write: if isOwner(userId) || isTeamMember(userId); }
      match /transactions/{doc=**} { allow read, write: if isOwner(userId) || isTeamMember(userId); }
      match /invoices/{doc=**} { allow read, write: if isOwner(userId) || isTeamMember(userId); }
      match /gstDocuments/{doc=**} { allow read, write: if isOwner(userId) || isTeamMember(userId); }
      match /suppliers/{doc=**} { allow read, write: if isOwner(userId) || isTeamMember(userId); }
      // Staff: allow public read for attendance lookup, writes only for owner/team
      match /staff/{doc=**} { allow read: if true; allow write: if isOwner(userId) || isTeamMember(userId); }
      // Attendance: allow public create for QR check-in, owner/team can read/write
      match /attendance/{doc=**} { allow create: if true; allow read, update, delete: if isOwner(userId) || isTeamMember(userId); }
      match /production_runs/{doc=**} { allow read, write: if isOwner(userId) || isTeamMember(userId); }
      match /product_master/{doc=**} { allow read, write: if isOwner(userId) || isTeamMember(userId); }
      match /mold_master/{doc=**} { allow read, write: if isOwner(userId) || isTeamMember(userId); }
      match /location_master/{doc=**} { allow read, write: if isOwner(userId) || isTeamMember(userId); }
      match /vehicles/{doc=**} { allow read, write: if isOwner(userId) || isTeamMember(userId); }
      match /vehicle_expenses/{doc=**} { allow read, write: if isOwner(userId) || isTeamMember(userId); }
      // Attendance settings must be readable publicly for check-in window
      match /settings/attendance { allow read: if true; allow write: if isOwner(userId) || isTeamMember(userId); }
      match /settings/{doc=**} { allow read, write: if isOwner(userId) || isTeamMember(userId); }
      match /challans/{doc=**} { allow read, write: if isOwner(userId) || isTeamMember(userId); }
      match /purchases/{doc=**} { allow read, write: if isOwner(userId) || isTeamMember(userId); }
    }
  }
}
